<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Academia Flow ‚Äî Plan + Chatbot (PWA)</title>
<link rel="manifest" href="manifest.webmanifest"/>
<meta name="theme-color" content="#2563eb"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>
<link rel="icon" type="image/png" href="icons/icon-192.png"/>
<style>
:root{
  --bg:#f6f8fc;--panel:#ffffff;--muted:#94a3b8;--text:#0f172a;--sub:#475569;
  --blue:#2563eb;--border:#d0d8e4;--grid:#e2e8f0;--cell:#ffffff;--hover:#f1f5f9;
  --indisp:#eef2f7;
  --t-red:#fce7e7;--t-yellow:#fff2cc;--t-blue:#dbeafe;--t-green:#dcfce7;--t-pink:#fce7f3;--t-orange:#ffedd5;--t-purple:#ede9fe;
}
*{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(180deg,var(--bg),#eef5ff);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);z-index:5;border-bottom:1px solid var(--border)}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
h1{margin:0 0 4px;font-size:clamp(18px,2.6vw,26px)} .sub{color:var(--sub);font-size:14px}
nav.tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
nav.tabs a{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);text-decoration:none;color:inherit}
nav.tabs a.active{outline:2px solid var(--blue)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
select,button,input,textarea{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
button{cursor:pointer} button:hover{filter:brightness(1.05)}
.page{display:none}.page.active{display:block}
.layout{display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start}
.left{position:sticky;top:150px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
.card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:15px;color:var(--sub);display:flex;justify-content:space-between;align-items:center}
.section{padding:12px 14px;display:grid;gap:10px}
.grid{overflow:auto;border-radius:16px;border:1px solid var(--border)}
table{border-collapse:separate;border-spacing:0;width:100%;min-width:1040px;background:var(--panel);transform-origin:0 0}
thead th{position:sticky;top:0;background:var(--panel);padding:10px;border-bottom:1px solid var(--border);font-weight:600}
tbody td, thead th{border-right:1px solid var(--grid)} tbody td:last-child, thead th:last-child{border-right:none}
tbody tr{border-bottom:1px solid var(--grid)}
.time{position:sticky;left:0;background:var(--panel);border-right:1px solid var(--border);font-weight:600}
td{padding:8px;min-width:130px;vertical-align:top;position:relative}
td.cell{cursor:pointer;background:var(--cell)} td.cell:hover{background:var(--hover)}
td.locked{background:#e8eefb;color:#334155;cursor:not-allowed}
.indisp{background:var(--indisp);color:#64748b}
.tag{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:8px;font-size:12px;border:1px solid #0001;box-shadow:inset 0 1px 0 #fff4}
#chatBtn{position:fixed;right:16px;bottom:16px;background:var(--blue);color:white;border:none;border-radius:999px;padding:12px 16px;box-shadow:0 8px 24px rgba(2,6,23,.25);z-index:70}
#chatPanel{position:fixed;right:16px;bottom:76px;width:min(360px,92vw);max-height:70vh;background:var(--panel);border:1px solid var(--border);border-radius:16px;display:none;flex-direction:column;overflow:hidden;z-index:70;box-shadow:0 20px 60px rgba(2,6,23,.35)}
#chatHeader{padding:12px;border-bottom:1px solid var(--border);font-weight:600}
#chatMessages{padding:10px;overflow:auto;display:grid;gap:8px}
.msg{display:flex;gap:8px}.msg.you{justify-content:flex-end}
.bubble{max-width:80%;padding:8px 10px;border-radius:10px;background:#edf2ff;color:#0f172a;border:1px solid #bcd1ff}
.msg.you .bubble{background:#e2f7e6;border-color:#79d58b}
#chatInputBar{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
.quick{display:flex;gap:6px;flex-wrap:wrap;padding:6px 10px;border-top:1px dashed var(--border)}
.quick button{font-size:12px;padding:6px 8px}
.drop-target{outline:2px solid var(--blue);outline-offset:-2px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Academia Flow ‚Äî Plan + Chatbot</h1>
    <div class="sub">PWA ¬∑ Guardado local ¬∑ CSV/ICS ¬∑ Notificaciones</div>
    <nav class="tabs">
      <a class="tab active" data-page="page-home" href="#home">üè† Inicio</a>
      <a class="tab" data-page="page-schedule" href="#schedule">üìÜ Horario</a>
      <a class="tab" data-page="page-tasks" href="#tasks">‚úÖ Tareas</a>
      <a class="tab" data-page="page-summary" href="#summary">üìä Resumen</a>
    </nav>
    <div class="toolbar">
      <button onclick="window.print()">Imprimir</button>
      <button id="enableNotiBtn">Activar notificaciones</button>
      <button id="exportICSBtn">Exportar .ics</button>
      <label>Zoom: <input id="zoomRange" type="range" min="0.8" max="1.4" step="0.05" value="1"></label>
      <button id="fullBtn">Pantalla completa</button>
    </div>
  </div>
</header>

<!-- HOME -->
<div class="wrap page active" id="page-home">
  <div class="card">
    <h3>Identificaci√≥n del estudiante</h3>
    <div class="section">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="stName" placeholder="Nombre del estudiante"/>
        <input id="stCourse" placeholder="Curso / Grado"/>
        <input id="stProgram" placeholder="Universidad / Programa"/>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <label>Inicio de semana (Lunes) <input id="mondayDate" type="date" placeholder="yyyy-mm-dd"/></label>
        <button id="saveStudentBtn">Guardar portada</button>
      </div>
    </div>
  </div>
</div>

<!-- SCHEDULE -->
<div class="wrap page" id="page-schedule">
  <div class="toolbar" style="margin-bottom:12px">
    <label>Semana: <select id="weekSelect"></select></label>
    <button id="saveBtn">Guardar semana</button>
    <button id="clearBtn">Limpiar semana</button>
    <button id="exportBtn">Exportar CSV</button>
  </div>

  <div class="layout">
    <aside class="left">
      <div class="card">
        <h3>Asignaturas</h3>
        <div class="section">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input id="subjectName" placeholder="Nombre"/>
            <input id="subjectColor" type="color" value="#2563eb"/>
            <label>Objetivo h: <input id="subjectTarget" type="number" step="0.5" min="0" style="width:90px" value="2"/></label>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="addSubject">A√±adir/Actualizar</button>
          </div>
          <div id="subjectsList"></div>
          <div class="sub">üí° Arrastra una asignatura y su√©ltala en el horario (crea bloque de 60 min).</div>
        </div>
      </div>
    </aside>

    <main class="grid card">
      <table id="schedule">
        <thead><tr>
          <th>Hora</th><th>Lunes</th><th>Martes</th><th>Mi√©rcoles</th><th>Jueves</th><th>Viernes</th><th>S√°bado</th><th>Domingo</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </main>
  </div>
</div>

<!-- TASKS -->
<div class="wrap page" id="page-tasks">
  <div class="card">
    <h3>Nueva tarea</h3>
    <div class="section">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <select id="taskSubject"></select>
        <input id="taskTitle" placeholder='T√≠tulo (p.ej. "Leer cap. 5")'/>
        <label>Fecha l√≠mite <input id="taskDue" type="date"/></label>
        <label>Estimaci√≥n <input id="taskEst" type="number" min="0" step="0.5" style="width:80px" value="1"/> h</label>
      </div>
      <button id="addTaskBtn">A√±adir tarea</button>
    </div>
  </div>
  <div class="card" style="margin-top:12px">
    <h3>Lista de tareas</h3>
    <div class="section" id="tasksList"></div>
  </div>
</div>

<!-- SUMMARY -->
<div class="wrap page" id="page-summary">
  <div class="card">
    <h3>Resumen</h3>
    <div class="section" id="summaryBox">
      <div>Horas planificadas: <b id="sPlan">0h</b> ¬∑ Horas reales: <b id="sReal">0h</b> ¬∑ % tareas completadas: <b id="sTasks">0%</b></div>
    </div>
  </div>
</div>

<!-- Chatbot -->
<button id="chatBtn">üí¨</button>
<div id="chatPanel">
  <div id="chatHeader">Asistente ‚Äî Academia Flow</div>
  <div id="chatMessages"></div>
  <div class="quick" id="chatQuick"></div>
  <div id="chatInputBar">
    <input id="chatInput" placeholder="Ej: 'Nuria martes 18:00' ¬∑ 'repite jueves' ¬∑ 'borra s√°bado 16:00'"/>
    <button id="chatSend">Enviar</button>
  </div>
</div>

<script>
// ===== PWA =====
if ('serviceWorker' in navigator) { window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js').catch(console.error)); }

// ===== Util =====
function toast(msg,ms=1500){ console.log(msg); }
function loadJSON(k,def){ try{const x=localStorage.getItem(k); return x?JSON.parse(x):def;}catch(e){return def;} }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

// ===== Navegaci√≥n =====
document.querySelectorAll('nav.tabs a').forEach(a=> a.addEventListener('click', (e)=>{
  e.preventDefault(); const id=a.dataset.page;
  document.querySelectorAll('nav.tabs a').forEach(t=>t.classList.remove('active')); a.classList.add('active');
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active');
  if(id==='page-summary') renderSummary();
}));

// ===== Datos base =====
const KEYS={ student:'flow::student.v1', subjects:'flow::subjects.v5', tasks:'flow::tasks.v2', week:w=>`flow::${w}`};
const DAYS=["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"]; const START_H=8, END_H=22;
const SLOTS=[]; for(let h=START_H; h<=END_H; h++){ SLOTS.push(String(h).padStart(2,'0')+':00'); if(h!==END_H) SLOTS.push(String(h).padStart(2,'0')+':30'); }
const tbody=document.getElementById('tbody'); const dayIndex=d=>DAYS.indexOf(d);

// ===== Portada =====
function loadStudent(){ const s=loadJSON(KEYS.student,{name:'',course:'',program:'',monday:''});
  document.getElementById('stName').value=s.name||'';
  document.getElementById('stCourse').value=s.course||'';
  document.getElementById('stProgram').value=s.program||'';
  document.getElementById('mondayDate').value=s.monday||'';
}
document.getElementById('saveStudentBtn').addEventListener('click',()=>{
  const s={
    name:document.getElementById('stName').value.trim(),
    course:document.getElementById('stCourse').value.trim(),
    program:document.getElementById('stProgram').value.trim(),
    monday:document.getElementById('mondayDate').value
  }; saveJSON(KEYS.student,s); toast('Portada guardada');
});

// ===== Grid =====
function isUnavailable(day,time){
  if(["Lunes","Mi√©rcoles","Viernes"].includes(day)){ if(time<"16:30") return true; }
  if(["Martes","Jueves"].includes(day)){ if(["14:00","14:30","15:00"].includes(time)) return true; }
  return false;
}
function renderGrid(){
  tbody.innerHTML='';
  for(const time of SLOTS){
    const tr=document.createElement('tr');
    const th=document.createElement('td'); th.textContent=time; th.className='time'; tr.appendChild(th);
    for(const day of DAYS){
      const td=document.createElement('td'); td.dataset.day=day; td.dataset.time=time;
      td.className = isUnavailable(day,time) ? 'cell indisp' : 'cell';
      td.addEventListener('click',()=>openEditor(td));
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

// ===== Subjects =====
function subjects(){ return loadJSON(KEYS.subjects, []); }
function setSubjects(list){ saveJSON(KEYS.subjects, list); renderSubjects(); renderTaskSubjects(); }
function renderSubjects(){
  const list=subjects();
  const div=document.getElementById('subjectsList'); div.innerHTML='';
  if(!list.length){ div.innerHTML='<div class="sub">(A√∫n no hay asignaturas)</div>'; return; }
  list.forEach((s,idx)=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center';
    row.innerHTML=`<span style="width:10px;height:10px;border-radius:999px;background:${s.color};display:inline-block"></span> <b>${s.name}</b> ¬∑ Obj: ${s.target}h`;
    row.setAttribute('draggable','true');
    row.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/subject', s.name); });
    const edit=document.createElement('button'); edit.textContent='Editar'; edit.onclick=()=>{ subjectName.value=s.name; subjectColor.value=s.color; subjectTarget.value=s.target; };
    const del=document.createElement('button'); del.textContent='Eliminar'; del.onclick=()=>{ const arr=subjects(); arr.splice(idx,1); setSubjects(arr); };
    div.appendChild(row); div.appendChild(edit); div.appendChild(del);
  });
}
const subjectName=document.getElementById('subjectName'), subjectColor=document.getElementById('subjectColor'), subjectTarget=document.getElementById('subjectTarget');
document.getElementById('addSubject').addEventListener('click',()=>{
  const name=subjectName.value.trim(); if(!name) return;
  const col=subjectColor.value; const tgt=parseFloat(subjectTarget.value||'0')||0;
  const arr=subjects(); const i=arr.findIndex(x=>x.name===name);
  if(i>=0){ arr[i].color=col; arr[i].target=tgt; } else { arr.push({name, color:col, target:tgt}); }
  setSubjects(arr); subjectName.value=''; subjectTarget.value='2';
});
function renderTaskSubjects(){ const sel=document.getElementById('taskSubject'); sel.innerHTML=''; (subjects()||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.name; o.textContent=s.name; sel.appendChild(o); }); }

// ===== Drag & drop to grid =====
function enableDrops(){
  tbody.querySelectorAll('td').forEach(td=>{
    td.addEventListener('dragover', e=>{ e.preventDefault(); td.classList.add('drop-target'); });
    td.addEventListener('dragleave', ()=> td.classList.remove('drop-target'));
    td.addEventListener('drop', async e=>{
      e.preventDefault(); td.classList.remove('drop-target');
      const subj = e.dataTransfer.getData('text/subject'); if(!subj) return;
      const tr = td.parentElement; const rowIdx = Array.from(tbody.children).indexOf(tr); const colIdx = td.cellIndex;
      const need = 2; // 60 min
      // overwrite simply
      for(let i=0;i<need;i++){
        const cell = tbody.children[rowIdx+i]?.children[colIdx];
        if(!cell) break; cell.className='cell'; cell.innerHTML='';
        const tag=document.createElement('span'); tag.className='tag'; tag.textContent='Uni ‚Äî '+subj; cell.appendChild(tag);
        const meta=document.createElement('span'); meta.className='meta'; meta.textContent=JSON.stringify({type:'study',subject:subj,plannedMin:30}); cell.appendChild(meta);
      }
      saveWeek();
    });
  });
}

// ===== Teacher hours (strict) =====
function teacherAllowed(day){
  if(['Martes','Jueves'].includes(day)) return ['18:00','19:00','20:00'];
  if(['S√°bado','Domingo'].includes(day)) return ['16:00','17:00','18:00'];
  return [];
}
async function addTeacherBlock(teacher, day, requested){
  const allowed=teacherAllowed(day); if(!allowed.length){ toast('Solo Ma/Ju 18‚Äì20 o Sa/Do 16‚Äì18'); return false; }
  const want=SLOTS.indexOf(requested||allowed[0]);
  const chosen = requested && allowed.includes(requested) ? requested : (allowed.find(h=>SLOTS.indexOf(h)>=want) || allowed[0]);
  const startIdx=SLOTS.indexOf(chosen); const dIdx=dayIndex(day);
  for(let i=0;i<2;i++){
    const td=tbody.children[startIdx+i]?.children[dIdx+1];
    if(!td) continue; td.className='cell'; td.innerHTML='';
    const tag=document.createElement('span'); tag.className='tag'; tag.textContent=`${teacher} ‚Äî ${chosen}`; td.appendChild(tag);
    const meta=document.createElement('span'); meta.className='meta'; meta.textContent=JSON.stringify({type:'teacher',teacher,plannedMin:30}); td.appendChild(meta);
  }
  saveWeek(); return true;
}

// ===== Editor m√≠nimo =====
function openEditor(cell){
  const day=cell.dataset.day, clickedTime=cell.dataset.time;
  const ed=document.createElement('div'); ed.style.position='absolute'; ed.style.background='var(--panel)'; ed.style.border='1px solid var(--border)'; ed.style.borderRadius='10px'; ed.style.padding='8px'; const r=cell.getBoundingClientRect(); ed.style.left=(window.scrollX+r.left+6)+'px'; ed.style.top=(window.scrollY+r.top+6)+'px';
  const typeSel=document.createElement('select'); ['(tipo)','Clase ‚Äî Profesor/a','Universidad ‚Äî Repaso','Descanso'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; typeSel.appendChild(o); });
  const durSel=document.createElement('select'); ['30','60','90','120'].forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m+' min'; durSel.appendChild(o);}); durSel.value='60';
  const profSel=document.createElement('select'); ['','Nuria','Juan Carlos'].forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n||'‚Äî profesor/a ‚Äî'; profSel.appendChild(o); });
  const subjSel=document.createElement('select'); const ph=document.createElement('option'); ph.value=''; ph.textContent='‚Äî asignatura ‚Äî'; subjSel.appendChild(ph); (subjects()||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.name; o.textContent=s.name; subjSel.appendChild(o); });
  const ok=document.createElement('button'); ok.textContent='Aplicar'; const cancel=document.createElement('button'); cancel.textContent='Cancelar'; cancel.style.marginLeft='6px';
  ok.addEventListener('click', async ()=>{
    const type=typeSel.value;
    if(type==='Clase ‚Äî Profesor/a'){
      if(!profSel.value) return;
      await addTeacherBlock(profSel.value, day, clickedTime);
    }else if(type==='Universidad ‚Äî Repaso'){
      const slots=Math.ceil((parseInt(durSel.value,10)||60)/30); const dIdx=dayIndex(day); const start=SLOTS.indexOf(clickedTime);
      for(let i=0;i<slots;i++){ const td=tbody.children[start+i]?.children[dIdx+1]; if(!td) continue; td.className='cell'; td.innerHTML=''; const t=document.createElement('span'); t.className='tag'; t.textContent=subjSel.value?('Uni ‚Äî '+subjSel.value):'Universidad ‚Äî Repaso'; td.appendChild(t); const m=document.createElement('span'); m.className='meta'; m.textContent=JSON.stringify({type:'study',subject:subjSel.value||null,plannedMin:30}); td.appendChild(m); }
      saveWeek();
    }else if(type==='Descanso'){
      const dIdx=dayIndex(day); const start=SLOTS.indexOf(clickedTime); const slots=Math.ceil((parseInt(durSel.value,10)||30)/30);
      for(let i=0;i<slots;i++){ const td=tbody.children[start+i]?.children[dIdx+1]; if(!td) continue; td.className='cell'; td.innerHTML=''; const t=document.createElement('span'); t.className='tag'; t.textContent='Descanso'; td.appendChild(t); const m=document.createElement('span'); m.className='meta'; m.textContent=JSON.stringify({type:'rest',plannedMin:30}); td.appendChild(m); }
      saveWeek();
    }
    document.body.removeChild(ed);
  });
  cancel.addEventListener('click',()=> document.body.removeChild(ed));
  ed.appendChild(typeSel); ed.appendChild(durSel); ed.appendChild(document.createElement('br')); ed.appendChild(profSel); ed.appendChild(document.createElement('br')); ed.appendChild(subjSel); ed.appendChild(document.createElement('br')); ed.appendChild(ok); ed.appendChild(cancel); document.body.appendChild(ed);
}

// ===== Semana / persistencia =====
const weekSelect=document.getElementById('weekSelect'); let currentWeek='Semana 1'; for(let i=1;i<=16;i++){ const o=document.createElement('option'); o.value=`Semana ${i}`; o.textContent=`Semana ${i}`; weekSelect.appendChild(o);} weekSelect.value=currentWeek;
function key(){ return KEYS.week(currentWeek); }
function saveWeek(){
  const data=[]; tbody.querySelectorAll('tr').forEach((tr,rowIdx)=>{
    const row={time:SLOTS[rowIdx]}; DAYS.forEach((day,i)=>{ const td=tr.children[i+1]; row[day]={html:td.innerHTML,cls:td.className}; }); data.push(row);
  }); saveJSON(key(),data); renderSummary();
}
function loadWeek(){
  renderGrid(); const raw=loadJSON(key(),null);
  if(raw){ raw.forEach((row,rIdx)=>{ const tr=tbody.children[rIdx]; DAYS.forEach((day,i)=>{ const td=tr.children[i+1]; td.innerHTML=row[day].html; td.className=row[day].cls||'cell'; }); }); }
  enableDrops();
}
document.getElementById('saveBtn').addEventListener('click',()=>{ saveWeek(); });
document.getElementById('clearBtn').addEventListener('click',()=>{ renderGrid(); saveWeek(); });

// ===== Export =====
document.getElementById('exportBtn').addEventListener('click',()=>{
  const rows=[["Hora",...DAYS]];
  tbody.querySelectorAll('tr').forEach((tr,rowIdx)=>{
    const line=[SLOTS[rowIdx]];
    DAYS.forEach((day,i)=>{
      const td=tr.children[i+1];
      const txt=td.querySelector('.tag')?.textContent || '';
      const note=td.querySelector('.meta')?.textContent || '';
      line.push('"'+(txt + (note? ' ‚Äî '+note:'' )).replaceAll('"','""')+'"');
    });
    rows.push(line);
  });
  const csv=rows.map(r=>r.join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download=`${currentWeek.replace(' ','_')}_horario.csv`; a.click();
});

// ===== Chatbot ("chatboy") =====
const chatBtn=document.getElementById('chatBtn'); const chatPanel=document.getElementById('chatPanel'); const chatMessages=document.getElementById('chatMessages'); const chatInput=document.getElementById('chatInput'); const chatSend=document.getElementById('chatSend'); const quickBar=document.getElementById('chatQuick');
chatBtn.addEventListener('click',()=>{ chatPanel.style.display = (chatPanel.style.display==='flex')?'none':'flex'; if(chatPanel.style.display!=='flex'){ chatPanel.style.display='flex'; chatPanel.style.flexDirection='column'; } });
function pushMsg(who, text){ const row=document.createElement('div'); row.className='msg '+(who==='you'?'you':'bot'); const b=document.createElement('div'); b.className='bubble'; b.textContent=text; row.appendChild(b); chatMessages.appendChild(row); chatMessages.scrollTop=chatMessages.scrollHeight; }
function dayTokenToName(tok){ tok=tok.toLowerCase(); if(tok.startsWith('lu'))return 'Lunes'; if(tok.startsWith('ma') && tok!=='may')return 'Martes'; if(tok.startsWith('mi'))return 'Mi√©rcoles'; if(tok.startsWith('ju'))return 'Jueves'; if(tok.startsWith('vi'))return 'Viernes'; if(tok.startsWith('sa'))return 'S√°bado'; if(tok.startsWith('do'))return 'Domingo'; return null; }
function parseTime(t){ const m=t.match(/^(\d{1,2})(?:[:h](\d{2}))?$/); if(!m) return null; let H=parseInt(m[1],10), M=m[2]?parseInt(m[2],10):0; if(H<0||H>23) return null; if(M!==0 && M!==30) M=0; return String(H).padStart(2,'0')+':'+String(M).padStart(2,'0'); }
function replyBot(text){
  const low=text.toLowerCase().trim();
  if(/ayuda|help|comandos/.test(low)){
    pushMsg('bot',"Comandos: 'Nuria martes 18:00', 'Juan Carlos domingo 16:00', 'repite jueves', 'borra s√°bado 16:00', 'exporta csv'.");
    return;
  }
  // colocar profesor
  let m = low.match(/(nuria|juan\s*car\w*)\s+(lunes|martes|mi[e√©]rcoles|jueves|viernes|s[√°a]bado|domingo)\s+(\d{1,2}[:h]\d{2}|\d{1,2})/i);
  if(m){
    const teacher = /nuria/i.test(m[1]) ? 'Nuria' : 'Juan Carlos'; const day = dayTokenToName(m[2]); const hour=parseTime(m[3]);
    if(!day||!hour) return pushMsg('bot','No entiendo el d√≠a/hora.');
    const ok = addTeacherBlock(teacher, day, hour);
    if(ok && ok.then){ ok.then(res=>{ pushMsg('bot', res?'He programado la clase.':'No se pudo colocar.'); saveWeek(); }); } else { pushMsg('bot', ok?'He programado la clase.':'No se pudo colocar.'); }
    return;
  }
  // borrar
  m = low.match(/borra\s+(lunes|martes|mi[e√©]rcoles|jueves|viernes|s[√°a]bado|domingo)\s+(\d{1,2}[:h]\d{2}|\d{1,2})/i);
  if(m){
    const day=dayTokenToName(m[1]); const hour=parseTime(m[2]); const dIdx=dayIndex(day); const r=SLOTS.indexOf(hour); const td=tbody.children[r]?.children[dIdx+1];
    if(td){ td.className='cell'; td.innerHTML=''; saveWeek(); pushMsg('bot','He borrado ese bloque.'); } else pushMsg('bot','No encontr√© la celda.');
    return;
  }
  pushMsg('bot','No entend√≠. Escribe "ayuda" para ver comandos.');
}
document.getElementById('chatSend').addEventListener('click',()=>{ const v=chatInput.value.trim(); if(!v) return; pushMsg('you',v); chatInput.value=''; replyBot(v); });
chatInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ document.getElementById('chatSend').click(); }});
['Ayuda','Nuria martes 18:00','Juan Carlos domingo 16:00','repite jueves','exporta csv'].forEach(q=>{ const b=document.createElement('button'); b.textContent=q; b.addEventListener('click',()=>{ pushMsg('you',q); replyBot(q); }); quickBar.appendChild(b); });

// ===== Init =====
function computeStats(){
  const res={planned:0, actual:0, tasks:{done:0,total:0}}; const t=loadJSON(KEYS.tasks, {}); Object.values(t).forEach(arr=>arr.forEach(it=>{res.tasks.total++; if(it.done) res.tasks.done++;}));
  for(let r=0;r<SLOTS.length;r++){ for(let d=0;d<DAYS.length;d++){ const td=tbody.children[r]?.children[d+1]; if(!td) continue; const m=td.querySelector('.meta'); if(!m) continue; try{ const mm=JSON.parse(m.textContent||'{}'); res.planned += mm.plannedMin||30; }catch(_){} } }
  return res;
}
function renderSummary(){ const s=computeStats(); document.getElementById('sPlan').textContent=(s.planned/60).toFixed(1)+'h'; document.getElementById('sReal').textContent=(s.actual/60).toFixed(1)+'h'; document.getElementById('sTasks').textContent = s.tasks.total? Math.round(100*s.tasks.done/s.tasks.total)+'%' : '0%'; }
function init(){ loadStudent(); renderSubjects(); renderTaskSubjects(); renderGrid(); loadWeek(); }
init();
</script>
</body>
</html>
